# Enrichment Pipeline
# Adds synonyms, normalizations, and metadata

input {
  http {
    port => 8082
    codec => json
    type => "enrichment"
  }
}

filter {
  # Add skill synonyms
  translate {
    field => "skill"
    destination => "skill_synonyms"
    dictionary => {
      "ml" => "machine learning"
      "ai" => "artificial intelligence"
      "dl" => "deep learning"
      "nlp" => "natural language processing"
      "cv" => "computer vision"
      "k8s" => "kubernetes"
      "tf" => "terraform"
      "js" => "javascript"
      "ts" => "typescript"
      "py" => "python"
      "pg" => "postgresql"
      "es" => "elasticsearch"
      "aws" => "amazon web services"
      "gcp" => "google cloud platform"
    }
    fallback => "%{skill}"
  }

  # Normalize text
  mutate {
    lowercase => ["skill", "technology"]
    strip => ["skill", "technology"]
  }

  # Add industry categorization
  ruby {
    code => '
      skill = event.get("skill").to_s.downcase

      if ["python", "java", "c++", "rust", "go"].include?(skill)
        event.set("category", "programming_language")
      elsif ["react", "angular", "vue", "django", "flask"].include?(skill)
        event.set("category", "framework")
      elsif ["postgresql", "mysql", "mongodb", "elasticsearch"].include?(skill)
        event.set("category", "database")
      elsif ["aws", "azure", "gcp", "docker", "kubernetes"].include?(skill)
        event.set("category", "cloud_devops")
      elsif ["machine learning", "ai", "deep learning", "nlp"].include?(skill)
        event.set("category", "ai_ml")
      else
        event.set("category", "other")
      end
    '
  }

  # Add metadata
  mutate {
    add_field => {
      "enriched_at" => "%{+YYYY-MM-dd HH:mm:ss}"
      "pipeline" => "enrichment"
    }
  }
}

output {
  # Send enriched data back to caller
  http {
    http_method => "post"
    url => "${CALLBACK_URL}"
    format => "json"
  }

  # Debug
  stdout {
    codec => rubydebug
  }
}
