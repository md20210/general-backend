# Job Description Parsing Pipeline
# Extracts requirements, responsibilities, company info from job descriptions

input {
  http {
    port => 8081
    codec => json
    type => "job"
  }
}

filter {
  # Extract company name
  grok {
    match => {
      "job_description" => "(?i)(Company|Organization|Firma):\s*(?<company>[A-Za-z0-9\s&\.-]+)"
    }
    tag_on_failure => []
  }

  # Extract location
  grok {
    match => {
      "job_description" => "(?i)(Location|Standort|Office):\s*(?<location>[A-Za-z\s,]+)"
    }
    tag_on_failure => []
  }

  # Extract remote policy
  grok {
    match => {
      "job_description" => "(?i)(remote|hybrid|on-site|vor ort)"
    }
    tag_on_failure => []
  }

  # Extract required skills
  grok {
    match => {
      "job_description" => [
        "(?i)require(d|ments)?:?\s*(?<requirements>.*?)(?=\n\n|\z)",
        "(?i)must\s*have:?\s*(?<must_have>.*?)(?=\n\n|\z)",
        "(?i)nice\s*to\s*have:?\s*(?<nice_to_have>.*?)(?=\n\n|\z)"
      ]
    }
    tag_on_failure => []
  }

  # Extract years of experience
  grok {
    match => {
      "job_description" => "(?i)(%{NUMBER:years_required})\+?\s*(years?|jahre)\s*(of\s*)?experience"
    }
    tag_on_failure => []
  }

  # Extract salary range
  grok {
    match => {
      "job_description" => "(?i)(%{NUMBER:salary_min})\s*[-–]\s*(%{NUMBER:salary_max})\s*(EUR|USD|€|\$)"
    }
    tag_on_failure => []
  }

  # Extract technical skills
  ruby {
    code => '
      tech_skills = []
      text = event.get("job_description").to_s.downcase

      # Programming languages
      ["python", "java", "javascript", "typescript", "go", "rust", "c++", "c#"].each do |lang|
        tech_skills << lang if text.include?(lang)
      end

      # Frameworks
      ["react", "angular", "vue", "django", "flask", "fastapi", "spring"].each do |fw|
        tech_skills << fw if text.include?(fw)
      end

      # Databases
      ["postgresql", "mysql", "mongodb", "redis", "elasticsearch"].each do |db|
        tech_skills << db if text.include?(db)
      end

      # Cloud & DevOps
      ["aws", "azure", "gcp", "docker", "kubernetes", "terraform"].each do |cloud|
        tech_skills << cloud if text.include?(cloud)
      end

      event.set("required_skills", tech_skills.uniq)
    '
  }

  # Add metadata
  mutate {
    add_field => {
      "[@metadata][index]" => "elastic_showcase_jobs"
      "processed_at" => "%{+YYYY-MM-dd HH:mm:ss}"
      "pipeline" => "job-parsing"
    }
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["${ELASTICSEARCH_HOST:elasticsearch.railway.internal:9200}"]
    index => "%{[@metadata][index]}"
    document_id => "%{job_id}"
    action => "index"
  }

  # Debug output
  stdout {
    codec => rubydebug
  }
}
